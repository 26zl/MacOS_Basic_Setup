name: macOS Test

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  macos-test:
    name: macOS Functionality Test
    runs-on: macos-latest
    env:
      NONINTERACTIVE: "1"
      CI: "1"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup and validation
        run: |
          echo "=== Setup and Validation ==="
          
          # Check for required files
          echo ""
          echo "=== Verifying required files ==="
          required_files=(
            "install.sh"
            "zsh.sh"
            "maintain-system.sh"
            "scripts/nix-macos-maintenance.sh"
            "quick-test.sh"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              missing_files+=("$file")
              echo "Missing: $file"
            else
              echo "Found: $file"
            fi
          done
          
          if [[ ${#missing_files[@]} -gt 0 ]]; then
            echo ""
            echo "ERROR: Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          # Check file permissions
          echo ""
          echo "=== Checking file permissions ==="
          chmod +x install.sh maintain-system.sh zsh.sh quick-test.sh 2>/dev/null || true
          chmod +x scripts/nix-macos-maintenance.sh 2>/dev/null || true
          
          # Test syntax
          echo ""
          echo "=== Testing syntax ==="
          zsh -n install.sh && echo "install.sh syntax OK" || { echo "install.sh syntax error"; exit 1; }
          zsh -n zsh.sh && echo "zsh.sh syntax OK" || { echo "zsh.sh syntax error"; exit 1; }
          zsh -n maintain-system.sh && echo "maintain-system.sh syntax OK" || { echo "maintain-system.sh syntax error"; exit 1; }
          zsh -n quick-test.sh && echo "quick-test.sh syntax OK" || { echo "quick-test.sh syntax error"; exit 1; }
          bash -n scripts/nix-macos-maintenance.sh && echo "nix-macos-maintenance.sh syntax OK" || { echo "nix-macos-maintenance.sh syntax error"; exit 1; }
          
          echo ""
          echo "All required files present and syntax valid"
          
          # Prepare fresh user home
          echo ""
          echo "=== Preparing fresh user home ==="
          fresh_home="$(mktemp -d)"
          echo "HOME=$fresh_home" >> "$GITHUB_ENV"
          echo "ZDOTDIR=$fresh_home" >> "$GITHUB_ENV"
          echo "XDG_DATA_HOME=$fresh_home/.local/share" >> "$GITHUB_ENV"
          echo "XDG_CONFIG_HOME=$fresh_home/.config" >> "$GITHUB_ENV"
          echo "XDG_CACHE_HOME=$fresh_home/.cache" >> "$GITHUB_ENV"
          echo "NONINTERACTIVE=1" >> "$GITHUB_ENV"
          mkdir -p "$fresh_home/.local/share" "$fresh_home/.config" "$fresh_home/.cache"
          echo "Fresh home directory prepared: $fresh_home"

      - name: Installation and validation
        run: |
          echo "=== Installation and Validation ==="
          
          # Test non-interactive mode handling
          echo ""
          echo "=== Testing non-interactive mode ==="
          echo "NONINTERACTIVE=${NONINTERACTIVE:-not set}"
          echo "CI=${CI:-not set}"
          
          # Install project
          echo ""
          echo "Testing install.sh on macOS with a clean HOME..."
          echo "HOME=$HOME"
          echo "XDG_DATA_HOME=${XDG_DATA_HOME:-not set}"
          export PATH="/usr/bin:/bin:/usr/sbin:/sbin"
          chmod +x install.sh maintain-system.sh zsh.sh 2>/dev/null || true
          
          # Use 'yes' command to automatically answer "yes" to all prompts
          # This simulates user answering "yes" to all interactive questions
          # Redirect yes stderr to /dev/null to avoid "Broken pipe" warnings
          (yes 2>/dev/null | ./install.sh 2>&1 | tee install.log) || true
          echo ""
          echo "=== Installation log summary ==="
          tail -100 install.log || true
          
          # Validate that interactive prompts are auto-answered in CI mode
          echo ""
          echo "=== Validating CI mode behavior ==="
          if grep -qiE "(Install Homebrew\?|Install MacPorts\?|Install mas|Install Nix\?)" install.log; then
            echo "Interactive prompts found - checking if they were auto-answered..."
            if grep -qiE "\[Auto: yes\]" install.log; then
              echo "OK: Interactive prompts correctly auto-answered in CI mode"
            else
              echo "WARNING: Prompts found but may not be auto-answered"
            fi
          else
            echo "No interactive prompts found (may be OK if all tools already installed)"
          fi
          
          # Verify that installation attempts were made in CI
          echo ""
          echo "=== Verifying installation attempts in CI ==="
          if grep -qiE "(Installing Homebrew|Installing mas|Installing MacPorts|Installing Nix)" install.log; then
            echo "OK: Installation attempts detected in CI mode"
          else
            echo "INFO: No installation attempts found (may be OK if all tools already installed)"
          fi
          
          # Verify that package managers are actually installed/available after install.sh
          echo ""
          echo "=== Verifying package manager installations ==="
          if command -v brew >/dev/null 2>&1; then
            echo "OK: Homebrew is installed and available"
            brew --version || echo "WARNING: Homebrew installed but version check failed"
          else
            echo "INFO: Homebrew not installed (may be OK if installation was skipped or failed)"
          fi
          
          if command -v mas >/dev/null 2>&1; then
            echo "OK: mas is installed and available"
            mas version || echo "WARNING: mas installed but version check failed"
          else
            echo "INFO: mas not installed (may be OK if Homebrew not available or installation was skipped)"
          fi
          
          if command -v port >/dev/null 2>&1; then
            echo "OK: MacPorts is installed and available"
            port version || echo "WARNING: MacPorts installed but version check failed"
          else
            echo "INFO: MacPorts not installed (may be OK if installation was skipped or requires sudo)"
          fi
          
          if command -v nix >/dev/null 2>&1 || [[ -f /nix/var/nix/profiles/default/bin/nix ]]; then
            echo "OK: Nix is installed and available"
            nix --version 2>/dev/null || echo "WARNING: Nix installed but version check failed"
          else
            echo "INFO: Nix not installed (may be OK if installation was skipped or requires sudo)"
          fi
          
          # Validate installation outputs
          echo ""
          echo "=== Validating installed files ==="
          [[ -d "$HOME/.oh-my-zsh" ]] || { echo "Missing ~/.oh-my-zsh"; exit 1; }
          [[ -f "$HOME/.zshrc" ]] || { echo "Missing ~/.zshrc"; exit 1; }
          [[ -f "$HOME/.zprofile" ]] || { echo "Missing ~/.zprofile"; exit 1; }
          
          # Check for maintain-system in both possible locations
          local_bin_1="$HOME/.local/bin/maintain-system"
          local_bin_2=""
          if [[ -n "${XDG_DATA_HOME:-}" ]]; then
            local_bin_2="${XDG_DATA_HOME}/../bin/maintain-system"
          fi
          
          if [[ -x "$local_bin_1" ]]; then
            echo "maintain-system found at $local_bin_1"
          elif [[ -n "$local_bin_2" && -x "$local_bin_2" ]]; then
            echo "maintain-system found at $local_bin_2"
          else
            echo "Missing maintain-system binary"
            echo "   Checked: $local_bin_1"
            [[ -n "$local_bin_2" ]] && echo "   Checked: $local_bin_2"
            find "$HOME" -name "maintain-system" -type f 2>/dev/null || true
            exit 1
          fi
          
          [[ -d "$HOME/.oh-my-zsh/custom/themes/powerlevel10k" ]] || { echo "Missing Powerlevel10k"; exit 1; }
          [[ -d "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" ]] || { echo "Missing zsh-syntax-highlighting"; exit 1; }
          [[ -d "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions" ]] || { echo "Missing zsh-autosuggestions"; exit 1; }
          
          # Validate shell config content
          echo ""
          echo "=== Validating shell config content ==="
          cmp -s zsh.sh "$HOME/.zshrc" || { echo "zsh.sh was not installed to ~/.zshrc as expected"; exit 1; }
          grep -q "FINAL PATH CLEANUP (FOR .ZPROFILE)" "$HOME/.zprofile" || { echo "Missing PATH cleanup block in ~/.zprofile"; exit 1; }
          grep -q "maintain_system_bin" "$HOME/.zshrc" || { echo "Missing maintain_system_bin in ~/.zshrc"; exit 1; }
          grep -q "alias update=" "$HOME/.zshrc" && echo "update alias definition found in ~/.zshrc" || echo "update alias definition not found (may be conditional)"
          grep -q "powerlevel10k/powerlevel10k" "$HOME/.zshrc" || { echo "Missing Powerlevel10k theme in ~/.zshrc"; exit 1; }
          grep -q "oh-my-zsh.sh" "$HOME/.zshrc" || { echo "Missing Oh My Zsh source line in ~/.zshrc"; exit 1; }
          
          # Test that install.sh functions exist
          echo ""
          echo "=== Testing install.sh functions ==="
          if grep -q "_ask_user" install.sh; then
            echo "_ask_user function found in install.sh"
          else
            echo "ERROR: _ask_user function not found in install.sh"
            exit 1
          fi
          
          if grep -q "install_homebrew\|install_macports\|install_mas\|install_nix" install.sh; then
            echo "Package manager install functions found in install.sh"
          else
            echo "ERROR: Package manager install functions not found in install.sh"
            exit 1
          fi
          
          # Test that install.sh has installation warnings
          if grep -qiE "IMPORTANT.*follow.*installation|Please follow.*carefully" install.sh; then
            echo "Installation warnings found in install.sh"
          else
            echo "WARNING: Installation warnings not found in install.sh"
          fi
          
          echo ""
          echo "Installation and validation complete"

      - name: Shell configuration and PATH
        run: |
          echo "=== Shell Configuration and PATH ==="
          
          # Validate PATH and tools in login shell
          echo "Validating PATH and tools via login shell..."
          zsh -lc 'command -v maintain-system >/dev/null' || { echo "maintain-system not in PATH"; exit 1; }
          zsh -lc 'command -v git >/dev/null' || { echo "git not available in login shell"; exit 1; }
          zsh -lc 'command -v brew >/dev/null' || { echo "Homebrew not available in login shell"; exit 1; }
          zsh -lc 'command -v fzf >/dev/null' || { echo "fzf not available in login shell"; exit 1; }
          zsh -lc '
            ms_path=$(command -v maintain-system 2>/dev/null || true)
            [[ -n "$ms_path" ]]
            ms_dir=${ms_path:h}
            case ":$PATH:" in *":$ms_dir:"*) exit 0 ;; *) exit 1 ;; esac
          ' || { echo "PATH missing maintain-system directory"; exit 1; }
          
          # Check Homebrew PATH with better error reporting
          zsh -lc '
            prefix=$(brew --prefix 2>/dev/null || true)
            if [[ -z "$prefix" ]]; then
              echo "ERROR: brew --prefix failed"
              exit 1
            fi
            expected_prefix="$prefix/bin:"
            if [[ "$PATH" == "$expected_prefix"* ]]; then
              exit 0
            else
              echo "ERROR: Homebrew bin not first in PATH"
              echo "Expected: $expected_prefix..."
              echo "Actual PATH: $PATH"
              echo "First 5 PATH entries:"
              echo "$PATH" | tr ":" "\n" | head -5
              exit 1
            fi
          ' || { echo "Homebrew bin not first in PATH"; exit 1; }
          
          # Test PATH cleanup functionality
          echo ""
          echo "Testing PATH cleanup in .zprofile..."
          zsh -lc '
            if grep -q "FINAL PATH CLEANUP (FOR .ZPROFILE)" "$HOME/.zprofile"; then
              echo "PATH cleanup block found in .zprofile"
            else
              echo "PATH cleanup block missing"
              exit 1
            fi
            
            prefix=$(brew --prefix 2>/dev/null || echo "")
            if [[ -n "$prefix" ]]; then
              if [[ "$PATH" == "$prefix/bin:"* ]]; then
                echo "Homebrew bin is first in PATH"
              else
                echo "Homebrew bin is not first in PATH"
                echo "   PATH starts with: ${PATH%%:*}"
                exit 1
              fi
            fi
          ' || exit 1
          
          # Test alias functionality
          echo ""
          echo "Testing alias functionality..."
          if grep -q "alias update=" "$HOME/.zshrc"; then
            echo "update alias definition exists in ~/.zshrc"
          else
            echo "update alias definition missing in ~/.zshrc"
            exit 1
          fi
          
          if grep -q "maintain_system_bin" "$HOME/.zshrc"; then
            echo "maintain_system_bin is defined in ~/.zshrc"
          else
            echo "maintain_system_bin missing in ~/.zshrc"
            exit 1
          fi
          
          if zsh -lc 'command -v maintain-system >/dev/null'; then
            echo "maintain-system is available in PATH"
          else
            echo "maintain-system not available in PATH"
            exit 1
          fi
          
          echo ""
          echo "Shell configuration and PATH validation complete"

      - name: Command testing
        run: |
          echo "=== Command Testing ==="

          # Test help/usage command
          echo "Testing help/usage output..."
          zsh -lc 'maintain-system --help 2>&1 || maintain-system help 2>&1 || maintain-system 2>&1' | tee help_output.txt

          if grep -qE "update|verify|versions" help_output.txt; then
            echo "help output shows available commands"
          else
            echo "help output format incorrect"
            cat help_output.txt
            exit 1
          fi

          if grep -qE "MAINTAIN_SYSTEM_.*=" help_output.txt; then
            echo "help output shows environment variables"
          else
            echo "WARNING: help output may not show environment variables"
          fi

          # Test invalid command
          echo ""
          echo "Testing invalid command handling..."
          if zsh -lc 'maintain-system invalid-command 2>&1' | grep -qE "Usage:|update|verify|versions"; then
            echo "Invalid command shows usage information"
          else
            echo "WARNING: Invalid command may not show usage"
          fi

          # Test verify command
          echo ""
          echo "Testing verify command output..."
          zsh -lc 'maintain-system verify' 2>&1 | tee verify_output.txt
          
          if grep -qE "^[A-Za-z][A-Za-z0-9_-]*[[:space:]]+(OK|WARN|Not installed)" verify_output.txt; then
            echo "verify output has correct format"
          else
            echo "verify output format incorrect"
            cat verify_output.txt
            exit 1
          fi
          
          if grep -q "Verify done\|==> Verify" verify_output.txt; then
            echo "verify command completed"
          else
            echo "verify command did not complete"
            exit 1
          fi
          
          # Test that verify shows mas if installed
          if command -v mas >/dev/null 2>&1; then
            if grep -qi "mas" verify_output.txt; then
              echo "mas detected in verify output"
            else
              echo "WARNING: mas installed but not shown in verify"
            fi
          else
            echo "mas not installed (this is OK)"
          fi
          
          # Test versions command
          echo ""
          echo "Testing versions command output..."
          zsh -lc 'maintain-system versions' 2>&1 | tee versions_output.txt
          
          if grep -qE "^[A-Za-z][A-Za-z0-9_-]*[[:space:]]+\." versions_output.txt || grep -q "TOOL VERSIONS" versions_output.txt; then
            echo "versions output has correct format"
          else
            echo "versions output format incorrect"
            cat versions_output.txt
            exit 1
          fi
          
          if grep -q "TOOL VERSIONS\|===" versions_output.txt; then
            echo "versions command completed"
          else
            echo "versions command did not complete"
            exit 1
          fi
          
          # Test that versions shows mas if installed
          if command -v mas >/dev/null 2>&1; then
            if grep -qi "mas" versions_output.txt; then
              echo "mas detected in versions output"
            else
              echo "WARNING: mas installed but not shown in versions"
            fi
          else
            echo "mas not installed (this is OK)"
          fi
          
          # Test error handling
          echo ""
          echo "Testing error handling for missing tools..."
          zsh -lc '
            output=$(maintain-system verify 2>&1)
            
            if echo "$output" | grep -q "Not found - skipping\|To install.*run.*install.sh"; then
              echo "Script handles missing tools gracefully (shows skip message with install.sh reference)"
            else
              echo "No missing tools detected (this is OK if all tools are installed)"
            fi
            
            if maintain-system verify >/dev/null 2>&1; then
              echo "Script handles missing package managers gracefully"
            else
              echo "Script failed on missing package managers"
              exit 1
            fi
          ' || exit 1
          
          echo ""
          echo "Command testing complete"

      - name: Package manager testing
        run: |
          echo "=== Package Manager Testing ==="
          
          # Test that maintain-system.sh skips missing package managers and refers to install.sh
          echo ""
          echo "Testing maintain-system.sh skip behavior..."
          zsh -lc '
            output=$(maintain-system verify 2>&1)
            
            # Check for skip messages with install.sh references (on separate lines)
            if echo "$output" | grep -qE "Not found - skipping" && echo "$output" | grep -qE "To install.*run.*install\.sh"; then
              echo "OK: maintain-system.sh correctly skips missing tools and refers to install.sh"
            else
              echo "WARNING: Skip messages with install.sh references not found"
              echo "This may be OK if all package managers are installed"
            fi
          ' || exit 1
          
          # Test mas update/upgrade functionality
          echo ""
          echo "Testing mas update/upgrade functionality..."
          if command -v mas >/dev/null 2>&1; then
            if grep -qE "mas upgrade.*mas update" maintain-system.sh && ! grep -q "sudo mas upgrade" maintain-system.sh; then
              echo "OK: mas upgrade and update commands found in maintain-system.sh (without sudo)"
            else
              echo "WARNING: mas upgrade/update commands may not be correct in maintain-system.sh"
            fi
            
            # Test that mas actually works
            if mas version >/dev/null 2>&1; then
              echo "OK: mas command works correctly"
              mas list 2>/dev/null | head -5 || echo "INFO: mas list may require App Store sign-in"
            else
              echo "WARNING: mas command may not work correctly"
            fi
          else
            echo "INFO: mas not installed (this is OK if Homebrew not available or installation was skipped)"
          fi
          
          # Test Homebrew skip behavior
          echo ""
          echo "Testing Homebrew skip behavior in maintain-system.sh..."
          if grep -qE "Not found - skipping" maintain-system.sh && grep -qE "To install Homebrew.*run.*install\.sh" maintain-system.sh; then
            echo "Homebrew skip message with install.sh reference found"
          else
            echo "WARNING: Homebrew skip message not found in maintain-system.sh"
          fi
          
          # Test MacPorts skip behavior
          echo ""
          echo "Testing MacPorts skip behavior in maintain-system.sh..."
          if grep -qE "Not found - skipping" maintain-system.sh && grep -qE "To install MacPorts.*run.*install\.sh" maintain-system.sh; then
            echo "OK: MacPorts skip message with install.sh reference found"
          else
            echo "WARNING: MacPorts skip message not found in maintain-system.sh"
          fi
          
          # Test mas skip behavior
          echo ""
          echo "Testing mas skip behavior in maintain-system.sh..."
          if grep -qE "Not found - skipping" maintain-system.sh && grep -qE "To install mas.*run.*install\.sh" maintain-system.sh; then
            echo "OK: mas skip message with install.sh reference found"
          else
            echo "WARNING: mas skip message not found in maintain-system.sh"
          fi
          
          # Test Nix skip behavior
          echo ""
          echo "Testing Nix skip behavior in maintain-system.sh..."
          if grep -qE "Not found - skipping" maintain-system.sh && grep -qE "To install Nix.*run.*install\.sh" maintain-system.sh; then
            echo "OK: Nix skip message with install.sh reference found"
          else
            echo "WARNING: Nix skip message not found in maintain-system.sh"
          fi
          
          # Test that installed package managers actually work with maintain-system
          echo ""
          echo "=== Testing installed package managers with maintain-system ==="
          zsh -lc '
            # Test verify command with installed package managers
            verify_output=$(maintain-system verify 2>&1)
            
            if command -v brew >/dev/null 2>&1; then
              if echo "$verify_output" | grep -qi "Homebrew.*OK\|Homebrew found"; then
                echo "OK: maintain-system correctly detects Homebrew"
              else
                echo "WARNING: maintain-system may not detect Homebrew correctly"
              fi
            fi
            
            if command -v mas >/dev/null 2>&1; then
              if echo "$verify_output" | grep -qi "mas.*OK\|mas found"; then
                echo "OK: maintain-system correctly detects mas"
              else
                echo "WARNING: maintain-system may not detect mas correctly"
              fi
            fi
            
            if command -v port >/dev/null 2>&1; then
              if echo "$verify_output" | grep -qi "MacPorts.*OK\|MacPorts found"; then
                echo "OK: maintain-system correctly detects MacPorts"
              else
                echo "WARNING: maintain-system may not detect MacPorts correctly"
              fi
            fi
            
            if command -v nix >/dev/null 2>&1 || [[ -f /nix/var/nix/profiles/default/bin/nix ]]; then
              if echo "$verify_output" | grep -qi "Nix.*OK\|Nix found"; then
                echo "OK: maintain-system correctly detects Nix"
              else
                echo "WARNING: maintain-system may not detect Nix correctly"
              fi
            fi
          ' || exit 1
          
          echo ""
          echo "Package manager testing complete"

      - name: Feature testing
        env:
          MAINTAIN_SYSTEM_CLEAN_PYENV: "0"
          MAINTAIN_SYSTEM_CLEAN_NVM: "0"
          MAINTAIN_SYSTEM_SWIFT_SNAPSHOTS: "1"
        run: |
          echo "=== Feature Testing ==="
          
          # Test update command
          echo "Testing update command..."
          python3 - <<'PYTHON_SCRIPT'
          import subprocess
          import sys
          from pathlib import Path

          cmd = ["zsh", "-lc", "maintain-system update"]
          try:
              result = subprocess.run(cmd, check=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, timeout=1800)
              output = result.stdout
          except subprocess.TimeoutExpired:
              print("Update timed out after 1800s")
              sys.exit(124)

          Path("update_output.txt").write_text(output)
          lines = output.splitlines()
          print("\n".join(lines[-200:]))
          
          if "Update finished" not in output:
              print("Update did not report completion")
              sys.exit(1)
          
          if any(keyword in output.lower() for keyword in ["updated", "upgraded", "installed", "success", "already up-to-date", "skipping"]):
              print("Update command executed and reported activity")
          else:
              print("Update command completed but no activity reported")
          
          if any(keyword in output.lower() for keyword in ["error", "failed", "fatal"]):
              print("Update reported some errors (may be OK for optional tools)")
          else:
              print("Update completed without fatal errors")
          
          # Test that update shows skip messages for missing tools
          if "Not found - skipping" in output or "To install" in output:
              print("Update correctly shows skip messages for missing tools")
          else:
              print("Update skip messages not found (may be OK if all tools are installed)")
          
          # Test that update does not modify project files
          print("")
          print("Testing that update does not modify project files...")
          import tempfile
          import os
          import shutil
          
          test_dir = tempfile.mkdtemp()
          os.chdir(test_dir)
          
          # Create test project files
          Path("Gemfile").write_text("source 'https://rubygems.org'\ngem 'test', '1.0.0'")
          Path("Gemfile.lock").write_text("test (1.0.0)")
          Path("package.json").write_text('{"name":"test","version":"1.0.0"}')
          Path("package-lock.json").write_text("package-lock.json content")
          Path("go.mod").write_text("module test")
          Path("go.sum").write_text("go.sum content")
          Path("requirements.txt").write_text("test==1.0.0")
          Path("requirements.lock").write_text("test==1.0.0")
          
          # Run update in test directory
          try:
              result = subprocess.run(cmd, check=False, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, timeout=300, cwd=test_dir)
          except subprocess.TimeoutExpired:
              print("Update test timed out (may be OK)")
          
          # Verify project files were not modified
          files_unchanged = True
          if Path("Gemfile.lock").read_text() != "test (1.0.0)":
              print("ERROR: Gemfile.lock was modified")
              files_unchanged = False
          if Path("package-lock.json").read_text() != "package-lock.json content":
              print("ERROR: package-lock.json was modified")
              files_unchanged = False
          if Path("go.mod").read_text() != "module test":
              print("ERROR: go.mod was modified")
              files_unchanged = False
          if Path("requirements.lock").read_text() != "test==1.0.0":
              print("ERROR: requirements.lock was modified")
              files_unchanged = False
          
          if files_unchanged:
              print("OK: Project files were not modified by update command")
          else:
              print("ERROR: Project files were modified - this violates the project file protection promise")
              sys.exit(1)
          
          # Cleanup
          os.chdir("/")
          shutil.rmtree(test_dir)
          
          # Test that update actually works with installed package managers
          import shutil
          if shutil.which("brew"):
              if "Homebrew" in output or "brew" in output.lower():
                  print("Update command interacts with Homebrew")
              else:
                  print("WARNING: Update may not interact with Homebrew")
          
          if shutil.which("mas"):
              if "mas" in output.lower() or "App Store" in output:
                  print("Update command interacts with mas")
              else:
                  print("WARNING: Update may not interact with mas")
          
          if shutil.which("port"):
              if "MacPorts" in output or "port" in output.lower():
                  print("Update command interacts with MacPorts")
              else:
                  print("WARNING: Update may not interact with MacPorts")
          
          nix_path = Path("/nix/var/nix/profiles/default/bin/nix")
          if shutil.which("nix") or nix_path.exists():
              if "Nix" in output or "nix" in output.lower():
                  print("Update command interacts with Nix")
              else:
                  print("WARNING: Update may not interact with Nix")
          PYTHON_SCRIPT
          
          # Test system Python/Ruby protection
          echo ""
          echo "Testing system Python/Ruby protection..."
          zsh -lc '
            if [[ ! -f update_output.txt ]]; then
              echo "update_output.txt not found (update step may have failed)"
              exit 1
            fi

            if [[ -f /usr/bin/python3 ]] || find /System/Library/Frameworks/Python.framework/Versions -type f -path "*/bin/python3" -print -quit 2>/dev/null | grep -q .; then
              echo "System Python detected"
              if grep -qi "system python" update_output.txt; then
                echo "System Python protection working (skipped in update)"
              else
                echo "System Python protection message not found (may be OK if no system Python)"
              fi
            else
              echo "No system Python found (this is OK)"
            fi
            
            if [[ -f /usr/bin/ruby ]] || find /System/Library/Frameworks/Ruby.framework/Versions -type f -path "*/bin/ruby" -print -quit 2>/dev/null | grep -q .; then
              echo "System Ruby detected"
              if grep -qi "system ruby" update_output.txt; then
                echo "System Ruby protection working (skipped in update)"
              else
                echo "System Ruby protection message not found (may be OK if no system Ruby)"
              fi
            else
              echo "No system Ruby found (this is OK)"
            fi
          ' || exit 1
          
          # Test environment variables
          echo ""
          echo "Testing environment variables..."
          zsh -lc '
            if [[ ! -f update_output.txt ]]; then
              echo "update_output.txt not found (update step may have failed)"
              exit 1
            fi

            if grep -qi "pyenv.*cleanup disabled" update_output.txt; then
              echo "MAINTAIN_SYSTEM_CLEAN_PYENV=0 works"
            else
              echo "MAINTAIN_SYSTEM_CLEAN_PYENV=0 test inconclusive (may be OK if pyenv not installed)"
            fi

            if grep -qi "nvm.*cleanup disabled" update_output.txt; then
              echo "MAINTAIN_SYSTEM_CLEAN_NVM=0 works"
            else
              echo "MAINTAIN_SYSTEM_CLEAN_NVM=0 test inconclusive (may be OK if nvm not installed)"
            fi

            echo "MAINTAIN_SYSTEM_SWIFT_SNAPSHOTS=1 set (will be used if swiftly is installed)"
          ' || exit 1

          # Test additional environment variables
          echo ""
          echo "Testing additional environment variables..."
          zsh -lc '
            # Test MAINTAIN_SYSTEM_FIX_RUBY_GEMS
            export MAINTAIN_SYSTEM_FIX_RUBY_GEMS=0
            output=$(maintain-system verify 2>&1 || true)
            if echo "$output" | grep -qi "ruby.*gems.*disabled\|skip.*ruby.*fix"; then
              echo "MAINTAIN_SYSTEM_FIX_RUBY_GEMS=0 works"
            else
              echo "MAINTAIN_SYSTEM_FIX_RUBY_GEMS=0 test inconclusive (may be OK if Ruby not installed or no gems issues)"
            fi

            # Test MAINTAIN_SYSTEM_CLEAN_CHRUBY
            export MAINTAIN_SYSTEM_CLEAN_CHRUBY=0
            output=$(maintain-system verify 2>&1 || true)
            if echo "$output" | grep -qi "chruby.*cleanup disabled"; then
              echo "MAINTAIN_SYSTEM_CLEAN_CHRUBY=0 works"
            else
              echo "MAINTAIN_SYSTEM_CLEAN_CHRUBY=0 test inconclusive (may be OK if chruby not installed)"
            fi

            # Test MAINTAIN_SYSTEM_PYENV_KEEP
            export MAINTAIN_SYSTEM_PYENV_KEEP="3.9.0 3.10.0"
            export MAINTAIN_SYSTEM_CLEAN_PYENV=1
            if maintain-system verify 2>&1 | grep -qi "pyenv"; then
              echo "MAINTAIN_SYSTEM_PYENV_KEEP environment variable set (will preserve versions if cleanup runs)"
            fi

            # Test MAINTAIN_SYSTEM_NVM_KEEP
            export MAINTAIN_SYSTEM_NVM_KEEP="16.0.0 18.0.0"
            export MAINTAIN_SYSTEM_CLEAN_NVM=1
            if maintain-system verify 2>&1 | grep -qi "nvm\|node"; then
              echo "MAINTAIN_SYSTEM_NVM_KEEP environment variable set (will preserve versions if cleanup runs)"
            fi

            # Test MAINTAIN_SYSTEM_CHRUBY_KEEP
            export MAINTAIN_SYSTEM_CHRUBY_KEEP="3.0.0 3.1.0"
            export MAINTAIN_SYSTEM_CLEAN_CHRUBY=1
            if maintain-system verify 2>&1 | grep -qi "chruby\|ruby"; then
              echo "MAINTAIN_SYSTEM_CHRUBY_KEEP environment variable set (will preserve versions if cleanup runs)"
            fi
          ' || exit 1
          
          # Test Go permanent configuration
          echo ""
          echo "Testing Go permanent configuration..."
          zsh -lc '
            if command -v go >/dev/null 2>&1; then
              echo "Go is installed"
              if grep -q "Managed by macOS Development Environment Setup - Go configuration" "$HOME/.zprofile" 2>/dev/null; then
                echo "Go configuration marker found in .zprofile"
              else
                echo "Go configuration marker not found (may be OK if Go was not updated)"
              fi
              if grep -q "export GOROOT=" "$HOME/.zprofile" 2>/dev/null; then
                echo "GOROOT export found in .zprofile"
              else
                echo "GOROOT export not found (may be OK if Go was not updated)"
              fi
            else
              echo "Go is not installed (this is OK - Go requires manual installation)"
            fi
          ' || exit 1
          
          # Test Homebrew auto-install skip behavior
          echo ""
          echo "Testing Homebrew skip behavior in maintain-system.sh..."
          zsh -lc '
            if grep -q "Not found - skipping\|To install Homebrew.*run.*install.sh" "$(command -v maintain-system)" 2>/dev/null; then
              echo "Homebrew skip logic detected in maintain-system.sh"
            else
              echo "Homebrew skip logic not found (may be OK if Homebrew is always present)"
            fi
          ' || exit 1
          
          # Test Swift installation
          echo ""
          echo "Testing Swift installation..."
          zsh -lc '
            if command -v swiftly >/dev/null 2>&1; then
              echo "swiftly is installed"
              output=$(maintain-system verify 2>&1 | grep -i "swift" || true)
              if echo "$output" | grep -qi "swift"; then
                echo "Swift is detected in verify"
              else
                echo "Swift not detected in verify (may be OK if not installed)"
              fi
            else
              echo "swiftly is not installed (this is OK - Swift is optional)"
            fi
          ' || exit 1
          
          # Test Nix maintenance script
          echo ""
          echo "Testing Nix maintenance script..."
          if [[ -f scripts/nix-macos-maintenance.sh ]]; then
            chmod +x scripts/nix-macos-maintenance.sh
            bash -n scripts/nix-macos-maintenance.sh && echo "nix-macos-maintenance.sh syntax OK" || { echo "nix-macos-maintenance.sh syntax error"; exit 1; }

            # Test help command
            if ./scripts/nix-macos-maintenance.sh help >/dev/null 2>&1; then
              echo "nix-macos-maintenance.sh help command works"
            else
              echo "nix-macos-maintenance.sh help command failed"
              exit 1
            fi

            # Test status command
            if ./scripts/nix-macos-maintenance.sh status >/dev/null 2>&1; then
              echo "nix-macos-maintenance.sh status command works"
            else
              echo "nix-macos-maintenance.sh status command failed (may be OK if Nix not installed)"
            fi

            # Test ensure-path command
            if ./scripts/nix-macos-maintenance.sh ensure-path >/dev/null 2>&1; then
              echo "nix-macos-maintenance.sh ensure-path command works"
            else
              echo "nix-macos-maintenance.sh ensure-path command failed (may be OK if Nix not installed)"
            fi

            # Test update command (dry-run style check)
            if ./scripts/nix-macos-maintenance.sh update 2>&1 | grep -qE "Nix not found|Updating Nix|nix upgrade-nix"; then
              echo "nix-macos-maintenance.sh update command works"
            else
              echo "WARNING: nix-macos-maintenance.sh update command may not work correctly"
            fi

            # Test preview-nix-upgrade command
            if ./scripts/nix-macos-maintenance.sh preview-nix-upgrade 2>&1 | grep -qE "Nix not found|Preview|nix-env"; then
              echo "nix-macos-maintenance.sh preview-nix-upgrade command works"
            else
              echo "WARNING: nix-macos-maintenance.sh preview-nix-upgrade command may not work correctly"
            fi

            # Test cleanup command
            if ./scripts/nix-macos-maintenance.sh cleanup 2>&1 | grep -qE "Nix not found|Cleaning up|nix-collect-garbage"; then
              echo "nix-macos-maintenance.sh cleanup command works"
            else
              echo "WARNING: nix-macos-maintenance.sh cleanup command may not work correctly"
            fi

            # Test fix-compaudit command
            if ./scripts/nix-macos-maintenance.sh fix-compaudit >/dev/null 2>&1; then
              echo "nix-macos-maintenance.sh fix-compaudit command works"
            else
              echo "nix-macos-maintenance.sh fix-compaudit command failed (may be OK)"
            fi

            # Test invalid command
            if ./scripts/nix-macos-maintenance.sh invalid-command 2>&1 | grep -qE "Unknown command|help"; then
              echo "nix-macos-maintenance.sh handles invalid commands correctly"
            else
              echo "WARNING: nix-macos-maintenance.sh may not handle invalid commands"
            fi

          else
            echo "scripts/nix-macos-maintenance.sh not found"
            exit 1
          fi
          
          # Test install.sh interactive functions
          echo ""
          echo "Testing install.sh interactive functions..."
          zsh -lc '
            # Test _ask_user function exists
            if grep -q "^_ask_user()" install.sh; then
              echo "_ask_user function found in install.sh"
            else
              echo "ERROR: _ask_user function not found in install.sh"
              exit 1
            fi
            
            # Test that _ask_user respects NONINTERACTIVE
            if grep -qE "NONINTERACTIVE.*CI" install.sh; then
              echo "_ask_user respects NONINTERACTIVE/CI environment variables"
            else
              echo "WARNING: _ask_user may not respect NONINTERACTIVE/CI"
            fi
            
            # Test installation warnings
            if grep -qiE "IMPORTANT.*follow.*installation|Please follow.*carefully" install.sh; then
              echo "Installation warnings found in install.sh"
            else
              echo "WARNING: Installation warnings not found in install.sh"
            fi
          ' || exit 1
          
          # Test Nix installation command
          echo ""
          echo "Testing Nix installation command..."
          if grep -qE "curl --proto.*=https.*--tlsv1.2.*nixos.org/nix/install" install.sh; then
            echo "Nix installation uses secure curl command with --proto and --tlsv1.2"
          else
            echo "WARNING: Nix installation may not use secure curl command"
          fi
          
          # Test MacPorts installation from source
          echo ""
          echo "Testing MacPorts installation from source..."
          if grep -qE "configure.*make.*make install|MacPorts.*source" install.sh; then
            echo "MacPorts installation from source found in install.sh"
          else
            echo "WARNING: MacPorts installation from source not found in install.sh"
          fi
          
          # Test edge cases
          echo ""
          echo "Testing edge cases with existing configuration..."
          zsh -lc '
            if [[ -f "$HOME/.zshrc" ]]; then
              cp "$HOME/.zshrc" "$HOME/.zshrc.test-backup"
              if ./install.sh 2>&1 | grep -q "backup\|Backing up"; then
                echo "install.sh handles existing .zshrc (creates backup)"
              else
                echo "install.sh backup logic not tested (may be OK)"
              fi
              mv "$HOME/.zshrc.test-backup" "$HOME/.zshrc" 2>/dev/null || true
            fi
          ' || exit 1

          # Test re-running install.sh
          echo ""
          echo "Testing re-running install.sh..."
          zsh -lc '
            # Run install.sh a second time to test idempotency
            if (yes 2>/dev/null | ./install.sh 2>&1 | tee install2.log); then
              echo "install.sh can be re-run successfully"
            else
              echo "WARNING: install.sh may have issues when re-run"
            fi

            # Check that re-running did not break anything
            if [[ -f "$HOME/.zshrc" ]] && [[ -f "$HOME/.zprofile" ]]; then
              echo "Re-running install.sh preserved configuration files"
            else
              echo "ERROR: Re-running install.sh broke configuration"
              exit 1
            fi
          ' || exit 1

          # Test backup creation
          echo ""
          echo "Testing backup creation..."
          zsh -lc '
            # Check if backups are created
            backup_count=$(find "$HOME" -maxdepth 1 -name ".zshrc.backup*" 2>/dev/null | wc -l)
            if [[ $backup_count -gt 0 ]]; then
              echo "Backup files created: $backup_count"
              find "$HOME" -maxdepth 1 -name ".zshrc.backup*" -type f | head -3
            else
              echo "No backup files found (may be OK if no backups were needed)"
            fi
          ' || exit 1

          # Test missing dependencies handling
          echo ""
          echo "Testing missing dependencies handling..."
          zsh -lc '
            # Test that scripts handle missing tools gracefully
            output=$(maintain-system verify 2>&1 || true)

            # Check for graceful handling of missing tools
            if echo "$output" | grep -qE "Not installed|Not found|skipping"; then
              echo "Scripts handle missing tools gracefully"
            else
              echo "No missing tools detected (all tools may be installed)"
            fi

            # Verify exit codes are reasonable
            if maintain-system verify >/dev/null 2>&1; then
              echo "maintain-system verify exits successfully even with missing tools"
            else
              echo "WARNING: maintain-system verify may exit with error on missing tools"
            fi
          ' || exit 1

          # Test PATH preservation
          echo ""
          echo "Testing PATH preservation across sessions..."
          zsh -lc '
            # Get PATH from login shell
            path1=$(zsh -lc "echo \$PATH")

            # Get PATH from interactive shell
            path2=$(zsh -ic "echo \$PATH")

            if [[ -n "$path1" ]] && [[ -n "$path2" ]]; then
              echo "PATH is set in both login and interactive shells"
            else
              echo "ERROR: PATH not set correctly"
              exit 1
            fi

            # Check that maintain-system is in PATH for both
            if zsh -lc "command -v maintain-system" >/dev/null && zsh -ic "command -v maintain-system" >/dev/null; then
              echo "maintain-system available in both shell types"
            else
              echo "ERROR: maintain-system not available in all shell types"
              exit 1
            fi
          ' || exit 1
          
          echo ""
          echo "Feature testing complete"

      - name: Quick test script
        run: |
          echo "=== Quick Test Script ==="

          if [[ -f quick-test.sh ]]; then
            chmod +x quick-test.sh

            # Test syntax
            zsh -n quick-test.sh && echo "quick-test.sh syntax OK" || { echo "quick-test.sh syntax error"; exit 1; }

            # Run quick test
            ./quick-test.sh 2>&1 | tee quick_test_output.txt

            if grep -qE "Quick Test|Test Complete|Testing|Checking" quick_test_output.txt; then
              echo "quick-test.sh completed successfully"
            else
              echo "WARNING: quick-test.sh may not have completed"
            fi

            # Verify quick-test checks important things
            if grep -qE "zshrc|zprofile|oh-my-zsh|maintain-system" quick_test_output.txt; then
              echo "quick-test.sh checks essential components"
            else
              echo "WARNING: quick-test.sh may not check essential components"
            fi


            # Test quick-test.sh exit code
            if ./quick-test.sh >/dev/null 2>&1; then
              echo "quick-test.sh exits successfully"
            else
              echo "WARNING: quick-test.sh may exit with error"
            fi
          else
            echo "quick-test.sh not found"
            exit 1
          fi

          echo ""
          echo "Quick test script validation complete"

      - name: Shell script validation
        run: |
          echo "=== Shell Script Validation ==="

          # Test zsh.sh content and structure
          echo "Testing zsh.sh structure..."
          if [[ -f zsh.sh ]]; then
            # Test syntax
            zsh -n zsh.sh && echo "zsh.sh syntax OK" || { echo "zsh.sh syntax error"; exit 1; }

            # Verify it contains essential zsh configuration
            if grep -q "oh-my-zsh" zsh.sh; then
              echo "zsh.sh contains Oh My Zsh configuration"
            else
              echo "ERROR: zsh.sh missing Oh My Zsh configuration"
              exit 1
            fi

            if grep -q "powerlevel10k" zsh.sh; then
              echo "zsh.sh contains Powerlevel10k configuration"
            else
              echo "ERROR: zsh.sh missing Powerlevel10k configuration"
              exit 1
            fi

            if grep -q "plugins=" zsh.sh; then
              echo "zsh.sh contains plugin configuration"
            else
              echo "ERROR: zsh.sh missing plugin configuration"
              exit 1
            fi

            # Verify maintain-system alias is configured
            if grep -qE "alias update=|maintain_system_bin" zsh.sh; then
              echo "zsh.sh contains maintain-system alias configuration"
            else
              echo "ERROR: zsh.sh missing maintain-system alias"
              exit 1
            fi

            # Test that zsh.sh was copied to .zshrc correctly
            if cmp -s zsh.sh "$HOME/.zshrc"; then
              echo "zsh.sh correctly installed to ~/.zshrc"
            else
              echo "ERROR: zsh.sh not correctly copied to ~/.zshrc"
              exit 1
            fi
          else
            echo "ERROR: zsh.sh not found"
            exit 1
          fi

          # Test all scripts for common issues
          echo ""
          echo "Testing scripts for common issues..."
          for script in install.sh maintain-system.sh zsh.sh quick-test.sh scripts/nix-macos-maintenance.sh; do
            if [[ -f "$script" ]]; then
              # Check for TODO/FIXME markers
              if grep -qE "TODO|FIXME|XXX" "$script"; then
                echo "WARNING: $script contains TODO/FIXME markers"
              fi

              # Check for hardcoded paths that might break
              if grep -qE "/Users/[^/]+/|/home/[^/]+" "$script" 2>/dev/null; then
                echo "WARNING: $script may contain hardcoded user paths"
              fi

              # Check for proper shebang
              if head -1 "$script" | grep -qE "^#!.*(zsh|bash|sh)"; then
                echo "$script has proper shebang"
              else
                echo "WARNING: $script may be missing shebang"
              fi
            fi
          done

          echo ""
          echo "Shell script validation complete"

      - name: Final summary
        run: |
          echo "=== Final Test Summary ==="
          echo ""
          echo "All tests completed successfully!"
          echo ""
          echo "Tested features:"
          echo "  - File syntax validation (all shell scripts)"
          echo "  - Installation process"
          echo "  - Non-interactive mode handling"
          echo "  - Shell configuration (zsh.sh structure and content)"
          echo "  - PATH management and preservation"
          echo "  - maintain-system commands (verify, versions, update, help, invalid command)"
          echo "  - nix-macos-maintenance.sh commands (status, ensure-path, update, preview-nix-upgrade, cleanup, fix-compaudit, help)"
          echo "  - Package manager skip behavior (Homebrew, MacPorts, mas, Nix)"
          echo "  - mas support and functionality"
          echo "  - Interactive install functions (_ask_user)"
          echo "  - Installation warnings"
          echo "  - Nix secure installation (--proto, --tlsv1.2)"
          echo "  - MacPorts source installation"
          echo "  - System Python/Ruby protection"
          echo "  - Environment variables (MAINTAIN_SYSTEM_CLEAN_PYENV, MAINTAIN_SYSTEM_CLEAN_NVM, MAINTAIN_SYSTEM_CLEAN_CHRUBY, MAINTAIN_SYSTEM_FIX_RUBY_GEMS, MAINTAIN_SYSTEM_SWIFT_SNAPSHOTS, *_KEEP variables)"
          echo "  - Edge cases (re-running install.sh, backup creation, existing configs)"
          echo "  - Missing dependencies handling"
          echo "  - PATH preservation across shell types"
          echo "  - quick-test.sh functionality and checks"
          echo "  - Go permanent configuration"
          echo "  - Swift installation with swiftly"
          echo "  - Code quality (shebangs, hardcoded paths, TODO markers)"
          echo ""
          echo "All tests passed!"
